<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>BLE_TEST_Ver_0.1</title>
</head>

<body>
BLE_Test 00
<br>
<button id="connect">接続</button>
<button id="disconnect">切断</button>
<br>
<br>
メッセージ送信<br>
<input id="message" value="hello" />
<button id="send">送信</button>
<br>
Hex送信<br>
<input id="Hex" value="" />
<button id="hexsend">送信</button>


<script src="d3/d3.min.js"></script>    

<script>
var bluetoothDevice;
var characteristic;
// UUIDの登録
var SERVICE_UUID         = '6926486a-34a8-11e9-b210-d663bd873d93';   // サービス
var MESSAGE_UUID         = '692655f8-34a8-11e9-b210-d663bd873d93';   // メッセージ
var LED1_UUID  		       = '692651b6-34a8-11e9-b210-d663bd873d93';   // LED1
  
// Characteristic
let message_Characteristic;
let led1_Characteristic;  
  
//ボタンイベントリスナー
d3.select("#connect").on("click", connect);
d3.select("#disconnect").on("click", disconnect);   
d3.select("#send").on("click", sendMessage);    
d3.select("#hexsend").on("click", sendHex);    
//デバイスに接続する
function connect() {
  let options = {};
//  options.acceptAllDevices = true;    // すべてのデバイスを表示
  // 特定のデバイスを表示
  options.filters = [
    {services: [SERVICE_UUID]},         // サービスUUIDの指定
//    {name: "BLE_01"}                    // デバイス名の指定
  ];
  
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    bluetoothDevice = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    console.log("server", server)
    return server.getPrimaryService(SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service)
//  return service.getCharacteristic(CHARACTERISTIC_UUID)
    return Promise.all([
        service.getCharacteristic(MESSAGE_UUID),
        service.getCharacteristic(LED1_UUID)
      
      ])
    
  })
  .then(characteristic  => {
    console.log("characteristic")
    alert("BLE接続成功");

    message_Characteristic = characteristic[0];
    sw_Characteristic = characteristic[1];

      console.log("success:connect BLE");    
  })  
  .catch(error => {
    console.log(error);
  });    
}
 
// メッセージを送信
function sendMessage() {
//  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var text = document.querySelector("#message").value;
  var arrayBuffe = new TextEncoder().encode(text);
  message_Characteristic.writeValue(arrayBuffe);        
} 
// メッセージを送信
function sendHex() {
//  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var text = document.querySelector("#message").value;
  var arrayBuffe = new TextEncoder().encode(text);
  sw_Characteristic.writeValue(arrayBuffe);        
} 
 
//BEL切断処理
function disconnect() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected) return ;
  bluetoothDevice.gatt.disconnect();
  alert("BLE切断")
}
 
</script>    
</body>
</html>
