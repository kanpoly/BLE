<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>BLE_TEST_Ver_0.1</title>
</head>

<body>
BLE_Test_rev_1.7
<br>
<button id="connect">接続</button>
<button id="disconnect">切断</button>
<br>
<br>
メッセージ送信<br>
<input id="message" value="hello" />
<button id="send">送信</button>
<br>
Hex送信<br>
<input id="Hex" value="" />
<button id="hexsend">送信</button>


<script src="d3/d3.min.js"></script>    

<script>
var bluetoothDevice;
var characteristic;


// UUIDの登録
var SERVICE_UUID         = '6926486a-34a8-11e9-b210-d663bd873d93';   // サービス

var SWITCH_UUID		 = '692655f8-34a8-11e9-b210-d663bd873d93';   // スイッチ
var ADC_UUID  		 = '69264cd4-34a8-11e9-b210-d663bd873d93';   // A/D値
var RESERVE_IN_UUID  	 = '69264e1e-34a8-11e9-b210-d663bd873d93';   // 予備入力
var MESSAGE_UUID  	 = '692655f8-34a8-11e9-b210-d663bd873d93';   // メッセージ

var LED1_UUID  		 = '692651b6-34a8-11e9-b210-d663bd873d93';   // LED1
var LED2_UUID  		 = '6926530a-34a8-11e9-b210-d663bd873d93';   // LED2
var RESERVE_OUT  	 = '6926544a-34a8-11e9-b210-d663bd873d93';   // 予備出力

//ボタンイベントリスナー
d3.select("#connect").on("click", connect);
d3.select("#disconnect").on("click", disconnect);   
d3.select("#send").on("click", sendMessage);    
d3.select("#hexsend").on("click", sendHex);    


// デバイスに接続する
function connect() {
  let options = {};
alert("通知あり1");
  options.acceptAllDevices = true;    // すべてのデバイスを表示
alert("通知あり2");
//  特定のデバイスを表示
//  options.filters = [
//    {services: [SERVICE_UUID]},         // サービスUUIDの指定
//    {name: "BLE_01"}                    // デバイス名の指定
//  ];
  
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    bluetoothDevice = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    console.log("server", server)
    return server.getPrimaryService(SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service)
 //   return service.getCharacteristic(CHARACTERISTIC_UUID)
 
     return Promise.all([
      service.getCharacteristic(SWITCH_UUID)
        .then( characteristic.addEventListener(SWITCH_UUID, onRecvSensorData)
               characteristic.startNotifications();),
        
      service.getCharacteristic(ADC_UUID)
        .then( characteristic.addEventListener(ADC_UUID, onRecvSensorData)
               characteristic.startNotifications();),
 
      service.getCharacteristic(RESERVE_IN_UUID)
        .then( characteristic.addEventListener(RESERVE_IN_UUID, onRecvSensorData)
               characteristic.startNotifications();),
 
      service.getCharacteristic(MESSAGE_UUID)
        .then( characteristic.addEventListener(MESSAGE_UUID, onRecvSensorData)
               characteristic.startNotifications();),
  })
  .then(chara => {
    console.log("characteristic", chara)
    alert("BLE接続成功");
    characteristic = chara;
  })  
  .catch(error => {
    console.log(error);
  });    
}
 
function onRecvSensorData(event) {//(1)

    let characteristic = event.target; //(2)
    let value = characteristic.value; //(3)

	if(characteristic==SWITCH_UUID){ alert("通知あり"); }
	
    
}

function decodeValue(msb, lsb, gain){
        return ((msb << 8) + lsb) * gain
} 
 
 
// メッセージを送信
function sendMessage() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var text = document.querySelector("#message").value;
  var arrayBuffe = new TextEncoder().encode(text);
  characteristic.writeValue(arrayBuffe);        
} 
// 16進数を送信
function sendHex() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var arrayBuffe = document.querySelector("#message").value;
  characteristic.writeValue(arrayBuffe);        
} 

 
//BEL切断処理
function disconnect() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected) return ;
  bluetoothDevice.gatt.disconnect();
  alert("BLE切断")
}
 
</script>    
</body>
</html>
