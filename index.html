
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>BLE_TEST_Ver_0.1</title>
</head>

<body>
BLE_Test 006.1
<br>
接続デバイス名 <input id="devicename" value="未接続" />
<br>  
<button id="connect">接続</button>
<button id="disconnect">切断</button>
<br>
<br>
LED_R<br>
<button id="led1_send_on">ON</button>  <button id="led1_send_off">OFF</button>
<br>
<br>
LED_G<br>
<button id="led2_send_on">ON</button>  <button id="led2_send_off">OFF</button>
<br>
<br>
LED_B<br>
<button id="led3_send_on">ON</button>  <button id="led3_send_off">OFF</button>
<br>
<br>
AD値受信<br>
<input id="val_adc" value="" />
<button id="adc_get">受信</button>  
<br> 
SW状態<br>
<input id="val_sw" value="" />
<button id="sw_get">受信</button>  
<br>
<br>
 

  

<script src="d3/d3.js"></script>    

<script>
var bluetoothDevice;
var characteristic;
// UUIDの登録
var SERVICE_UUID    = '538b6cdb-d0b6-42d2-962b-fb9cb91c8cd2';   // サービス
var SWITCH_UUID		  = 'e70eb45c-30e1-49f0-9cde-a5771f918791';   // スイッチ
var ADC_UUID  		  = '552ab02b-1973-4C3b-87e5-f32384e10481';   // A/D値
var RESERVE_IN_UUID = '69264e1e-34a8-11e9-b210-d663bd873d93';   // 予備入力
var MESSAGE_UUID  	= '692655f8-34a8-11e9-b210-d663bd873d93';   // メッセージ
var LED1_UUID  		  = '4d29e6e0-6996-4a57-bd27-eaf21bd750f6';   // LED1
var LED2_UUID  		  = 'ab1329eb-0f03-4b35-b12c-d980481c2cf9';   // LED2
var LED3_UUID  		  = 'c6cbb71b-61ca-4b52-9e0d-c412398273b9';   // LED3  
var RESERVE_OUT  	  = '6926544a-34a8-11e9-b210-d663bd873d93';   // 予備出力
  
// キャラクタの登録
let sw_Characteristic;  
let adc_Characteristic;  
let reserve_in_Characteristic;
let message_Characteristic;
  
let led1_Characteristic;
let led2_Characteristic;  
let led3_Characteristic;   
  
  
//ボタンイベントリスナー
d3.select("#connect").on("click", connect);
d3.select("#disconnect").on("click", disconnect);
d3.select("#led1_send_on").on("click", send_led1_on);
d3.select("#led1_send_off").on("click", send_led1_off);
d3.select("#led2_send_on").on("click", send_led2_on);
d3.select("#led2_send_off").on("click", send_led2_off);
d3.select("#led3_send_on").on("click", send_led3_on);
d3.select("#led3_send_off").on("click", send_led3_off);  
d3.select("#sw_get").on("click", get_sw);
d3.select("#adc_get").on("click", get_adc);
  
  
  //デバイスに接続する
function connect() {
  let options = {};
  //  options.acceptAllDevices = true;    // すべてのデバイスを表示
  // 特定のデバイスを表示
   options.filters = [
     {services: [SERVICE_UUID]},         // サービスUUIDの指定
  //    {name: "BLE_01"}                    // デバイス名の指定
   ];
  
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    bluetoothDevice = device;
    console.log("device", device);
    return device.gatt.connect();
  })
  .then(server =>{
    console.log("server", server)
    return server.getPrimaryService(SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service)
//  return service.getCharacteristic(CHARACTERISTIC_UUID)
    return Promise.all([
        service.getCharacteristic(LED1_UUID),
        service.getCharacteristic(LED2_UUID),
        service.getCharacteristic(LED3_UUID),      
        service.getCharacteristic(ADC_UUID),
      service.getCharacteristic(SWITCH_UUID),
      
      ])
    
  })
  .then(characteristic  => {
    console.log("characteristic")
    alert("BLE接続成功");
    document.querySelector("#devicename").value = bluetoothDevice.name;
    led1_Characteristic = characteristic[1];
    led2_Characteristic = characteristic[2];
    led3_Characteristic = characteristic[3];
    adc_Characteristic = characteristic[4];
    sw_Characteristic = characteristic[5];    
      console.log("success:connect BLE");    
  })  
  .catch(error => {
    console.log(error);
  });    
}
 
 
// led1 on 送信
function send_led1_on() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led1_Characteristic.writeValue(new TextEncoder().encode("FF"));        
} 
  
// led1 off 送信
function send_led1_off() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led1_Characteristic.writeValue(new TextEncoder().encode("00"));        
} 
  
// led2 on 送信
function send_led2_on() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led2_Characteristic.writeValue(new TextEncoder().encode("FF"));        
} 
  
// led2 off 送信
function send_led2_off() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led2_Characteristic.writeValue(new TextEncoder().encode("00"));        
}
  
// led3 on 送信
function send_led3_on() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led2_Characteristic.writeValue(new TextEncoder().encode("FF"));        
} 
  
// led3 off 送信
function send_led3_off() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected ) return ;
  led2_Characteristic.writeValue(new TextEncoder().encode("00"));        
}
  
  
// sw 受信 
function get_sw() {
let sw_val=0;
  try {
      sw_Characteristic.readValue()
      .then(value1 => {
         sw_val = value1;
        console.log(new Uint8Array(sw_val));
        document.querySelector("#val_sw").value = new TextDecoder("utf-8").decode(sw_val);
      });   
  }
  catch (e) {
    console.log(e);
  }
}
  
// ad 受信 
function get_adc() {
let adc_val=0;
  try {
      adc_Characteristic.readValue()
      .then(value2 => {
         adc_val = value2;
        console.log(new Uint8Array(adc_val));
        document.querySelector("#val_adc").value = new TextDecoder("utf-8").decode(adc_val);
      });   
  }
  catch (e) {
    console.log(e);
  }
}
  
//BEL切断処理
function disconnect() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected) return ;
    document.querySelector("#devicename").value = "未接続";
  bluetoothDevice.gatt.disconnect();
  alert("BLE切断")
}
 
</script>    
</body>
</html>
